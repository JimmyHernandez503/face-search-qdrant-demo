version: "3.8"

services:
  api:
    # Servicio FastAPI de la demo
    container_name: infierno-api
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    # API interna escucha en 7860, la exponemos en el host en 9000
    ports:
      - "9000:7860"
    # En el código normalmente se usa el host 'qdrant', así que dejamos
    # el servicio llamado 'qdrant' y solo cambiamos el container_name.
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
    depends_on:
      - qdrant
    # Montajes típicos (ajusta si tu repo usa otros)
    volumes:
      - ./logs:/logs
      - ./state:/state
      - ./thumbs:/data/thumbs
      - ./models:/models
    # Usa GPU si está disponible
    gpus: all

  qdrant:
    # Motor de vectores Qdrant de la demo
    container_name: infierno-qdrant
    image: qdrant/qdrant:v1.9.1
    restart: unless-stopped
    # Qdrant escucha dentro del contenedor en 6333/6334,
    # lo exponemos en 9001 y 9002 para no pisar otra instancia.
    ports:
      - "9001:6333"
      - "9002:6334"
    volumes:
      - ./qdrant_storage:/qdrant/storage
